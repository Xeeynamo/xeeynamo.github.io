name: Build and Deploy

on:
  push:
    branches:
      - master
      - retro-90s
      - halloween-theme
      - valentine
      - win95
  schedule:
    # Run twice a month on 1st and 15th for retro easter egg
    - cron: "0 0 1,15 * *"
    # Run daily at midnight to ensure correct version is deployed
    - cron: "0 0 * * *"

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Determine which branch to deploy
        id: branch
        run: |
          DAY=$(date +%d)
          MONTH=$(date +%m)

          # Valentine's Day theme: Feb 7-14 (week of Valentine's Day)
          if [ "$MONTH" = "02" ] && [ "$DAY" -ge "7" ] && [ "$DAY" -le "14" ]; then
            echo "branch=valentine" >> $GITHUB_OUTPUT
            echo "ðŸ’– Deploying romantic Valentine's Day theme!" >> $GITHUB_STEP_SUMMARY
          # Windows 98 release: June 25, 1998
          elif [ "$MONTH" = "06" ] && [ "$DAY" = "25" ]; then
            echo "branch=win95" >> $GITHUB_OUTPUT
            echo "ðŸªŸ Deploying Windows 95 theme for Windows 98 anniversary!" >> $GITHUB_STEP_SUMMARY
          # Windows 95 release: August 24, 1995
          elif [ "$MONTH" = "08" ] && [ "$DAY" = "24" ]; then
            echo "branch=win95" >> $GITHUB_OUTPUT
            echo "ðŸªŸ Deploying Windows 95 theme for Windows 95 anniversary!" >> $GITHUB_STEP_SUMMARY
          # Halloween theme: last week of October (Oct 25-31)
          elif [ "$MONTH" = "10" ] && [ "$DAY" -ge "25" ]; then
            echo "branch=halloween-theme" >> $GITHUB_OUTPUT
            echo "ðŸŽƒ Deploying spooky Halloween theme!" >> $GITHUB_STEP_SUMMARY
          # Retro 90s theme: 1st and 15th of each month
          elif [ "$DAY" = "01" ] || [ "$DAY" = "15" ]; then
            echo "branch=retro-90s" >> $GITHUB_OUTPUT
            echo "ðŸŽ‰ Deploying retro 90s easter egg!" >> $GITHUB_STEP_SUMMARY
          # Normal version: all other days
          else
            echo "branch=master" >> $GITHUB_OUTPUT
            echo "ðŸ“„ Deploying normal version" >> $GITHUB_STEP_SUMMARY
          fi

      - uses: actions/checkout@v4
        with:
          ref: ${{ steps.branch.outputs.branch }}

      - uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - run: npm ci
      - run: npm test
      - run: npm run build

      - uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: dist
